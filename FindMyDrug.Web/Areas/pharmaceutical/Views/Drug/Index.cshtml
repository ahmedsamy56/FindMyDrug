@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Index";
    Layout = "_Layout";
    var pharmacyId = ViewBag.pharmacyId;
}

<h1 class="text-center my-4">Drugs</h1>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


<a asp-area="pharmaceutical"
   asp-controller="Drug"
   asp-action="AddDrug"
   asp-route-Id="@pharmacyId"
   class="btn btn-success btn-lg mb-4 d-flex align-items-center justify-content-center">
    <i class="fas fa-plus me-2"></i> Add Drug
</a>

<div class="container">
    <div class="table-responsive">
        <table id="drugTable" class="table table-striped table-hover dt-responsive nowrap" width="100%" cellspacing="0">
            <thead >
                <tr>
                    <th>#</th>
                    <th>Drug Name</th>
                    <th>Dosage</th>
                    <th>Price</th>
                    <th>Availability</th>
                    <th>Blocked Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {

            var table = $('#drugTable').DataTable({
                "ajax": {
                    "url": "@Url.Action("GetData", new { id = ViewBag.pharmacyId })",
                    "type": "GET",
                    "dataSrc": ""
                },
               "columns": [
                        {
                            "data": null,
                            "orderable": true,
                            "render": function (data, type, row, meta) {
                                return meta.row + 1;
                            }
                        },
                        { "data": "name" },
                        { "data": "dosage" },
                        { "data": "price" },
                        {
                            "data": "isAvailable",
                            "render": function (data) {
                                return data ? "<span class='badge bg-success'>Yes</span>" : "<span class='badge bg-danger'>No</span>";
                            }
                        },
                        {
                            "data": "isBlocked",
                            "render": function (data) {
                                return data ? "<span class='badge bg-danger'>Blocked</span>" : "<span class='badge bg-success'>Active</span>";
                            }
                        },
                        {
                            "data": null,
                            "orderable": false,
                            "render": function (data, type, row) {
                                const icon = row.isAvailable ? 'fa-eye-slash' : 'fa-eye';
                                const buttonClass = row.isAvailable ? 'btn-warning' : 'btn-info';
                                return `
                                    <a href='/pharmaceutical/Drug/Update/${row.id}' class='btn btn-primary btn-sm'>Update</a>
                                    <button class='btn btn-danger btn-sm' onclick='deleteDrug(${row.id})'>Delete</button>
                                    <button class='btn ${buttonClass} btn-sm' id='toggle-availability-${row.id}' onclick='toggleAvailability(${row.id})'>
                                        <i class="fas ${icon}"></i>
                                    </button>
                                `;
                            }
                        }
                    ],
                "order": [[0, "asc"]],
                "lengthMenu": [10, 25, 50, 100],
                "pageLength": 10,
                "language": {
                    "search": "Filter:",
                    "lengthMenu": "Display _MENU_ records per page",
                    "info": "Showing page _PAGE_ of _PAGES_",
                    "infoEmpty": "No records available",
                    "zeroRecords": "No matching records found"
                }
            });
        });

        function toggleAvailability(drugId) {
            $.ajax({
                url: '@Url.Action("ToggleAvailabilityAction", "Drug")/' + drugId,
                type: 'POST',
                success: function (result) {
                    if (result.success) {
                        const newIcon = result.newAvailability ? 'fa-eye-slash' : 'fa-eye';
                        const newButtonClass = result.newAvailability ? 'btn-warning' : 'btn-info';
                        const button = $('#toggle-availability-' + drugId);

                        button.html(`<i class="fas ${newIcon}"></i>`);
                        button.removeClass('btn-warning btn-info').addClass(newButtonClass);

                        $('#drugTable').DataTable().ajax.reload();
                    } else {
                        alert('Error updating availability');
                    }
                },
                error: function (error) {
                    alert('Error: ' + error.responseText);
                }
            });
        }

        function deleteDrug(drugId) {
            if (confirm("Are you sure you want to delete this drug?")) {
                $.ajax({
                    url: '@Url.Action("Delete", "Drug")/' + drugId,
                    type: 'DELETE',
                    success: function (result) {
                        if (result.success) {
                            $('#drugTable').DataTable().ajax.reload();
                        } else {
                            alert('Error deleting drug');
                        }
                    },
                    error: function (error) {
                        alert('Error: ' + error.responseText);
                    }
                });
            }
        }
    </script>
}
